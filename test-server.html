<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste Servidor TÃ¢b</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      max-width: 600px;
      width: 100%;
    }
    h1 {
      color: #333;
      margin-bottom: 30px;
      text-align: center;
      font-size: 28px;
    }
    .test-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .test-section h2 {
      color: #667eea;
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .status {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ccc;
    }
    .status.success { background: #10b981; }
    .status.error { background: #ef4444; }
    .status.pending { background: #f59e0b; animation: pulse 1.5s infinite; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
      transition: all 0.3s;
    }
    button:hover { background: #5568d3; transform: translateY(-2px); }
    button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    
    .log {
      background: #1e293b;
      color: #10b981;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
      line-height: 1.6;
    }
    .log .error { color: #ef4444; }
    .log .info { color: #3b82f6; }
    .log .success { color: #10b981; }
    
    input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 10px;
      transition: border 0.3s;
    }
    input:focus {
      outline: none;
      border-color: #667eea;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ§ª Teste de Servidor TÃ¢b</h1>
    
    <!-- Teste 1: ConexÃ£o BÃ¡sica -->
    <div class="test-section">
      <h2><span class="status" id="status1"></span> 1. ConexÃ£o ao Servidor</h2>
      <p>URL: <strong id="serverUrl">http://localhost:8100</strong></p>
      <button onclick="testConnection()">Testar ConexÃ£o</button>
    </div>
    
    <!-- Teste 2: Registo/Login -->
    <div class="test-section">
      <h2><span class="status" id="status2"></span> 2. Registo de Utilizador</h2>
      <input type="text" id="testNick" placeholder="Username" value="testuser">
      <input type="password" id="testPass" placeholder="Password" value="123456">
      <button onclick="testRegister()">Registar/Login</button>
    </div>
    
    <!-- Teste 3: Join Game -->
    <div class="test-section">
      <h2><span class="status" id="status3"></span> 3. Entrar num Jogo</h2>
      <button onclick="testJoin()" id="btnJoin" disabled>Entrar (Grupo 81, size 9)</button>
      <p id="gameInfo" style="margin-top:10px; color:#667eea; font-weight:bold;"></p>
    </div>
    
    <!-- Teste 4: SSE Stream -->
    <div class="test-section">
      <h2><span class="status" id="status4"></span> 4. Stream de Updates (SSE)</h2>
      <button onclick="testSSE()" id="btnSSE" disabled>Conectar ao Stream</button>
    </div>
    
    <!-- Log de Testes -->
    <div class="log" id="log">
      <div class="info">ðŸš€ Pronto para testar...</div>
      <div class="info">ðŸ‘‰ Certifica-te que o servidor Node.js estÃ¡ a correr!</div>
      <div class="info">   Terminal: <code>cd node && node index.js</code></div>
    </div>
  </div>

  <script>
    const SERVER = "http://localhost:8100";
    let currentGame = null;
    let currentNick = null;
    let currentPass = null;
    let eventSource = null;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const line = document.createElement('div');
      line.className = type;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(line);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function setStatus(id, status) {
      const el = document.getElementById(id);
      el.className = 'status ' + status;
    }

    async function testConnection() {
      setStatus('status1', 'pending');
      log('ðŸ” Testando conexÃ£o ao servidor...', 'info');
      
      try {
        const res = await fetch(`${SERVER}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nick: 'ping', password: 'test' })
        });
        
        if (res.ok) {
          setStatus('status1', 'success');
          log('âœ… Servidor estÃ¡ online e a responder!', 'success');
          document.getElementById('btnJoin').disabled = false;
        } else {
          throw new Error(`HTTP ${res.status}`);
        }
      } catch (error) {
        setStatus('status1', 'error');
        log(`âŒ Erro de conexÃ£o: ${error.message}`, 'error');
        log('ðŸ’¡ Verifica se o servidor estÃ¡ a correr (node index.js)', 'info');
      }
    }

    async function testRegister() {
      setStatus('status2', 'pending');
      const nick = document.getElementById('testNick').value.trim();
      const pass = document.getElementById('testPass').value.trim();
      
      if (!nick || !pass) {
        log('âŒ Preenche username e password!', 'error');
        setStatus('status2', 'error');
        return;
      }
      
      log(`ðŸ“ Registando utilizador: ${nick}...`, 'info');
      
      try {
        const res = await fetch(`${SERVER}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nick, password: pass })
        });
        
        const data = await res.json();
        
        if (res.ok) {
          currentNick = nick;
          currentPass = pass;
          setStatus('status2', 'success');
          log(`âœ… Utilizador "${nick}" registado com sucesso!`, 'success');
          document.getElementById('btnJoin').disabled = false;
        } else {
          throw new Error(data.error || 'Register failed');
        }
      } catch (error) {
        setStatus('status2', 'error');
        log(`âŒ Erro no registo: ${error.message}`, 'error');
      }
    }

    async function testJoin() {
      if (!currentNick || !currentPass) {
        log('âŒ Faz login primeiro!', 'error');
        return;
      }
      
      setStatus('status3', 'pending');
      log('ðŸŽ® Tentando entrar num jogo...', 'info');
      
      try {
        const res = await fetch(`${SERVER}/join`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            group: 81,
            nick: currentNick,
            password: currentPass,
            size: 9
          })
        });
        
        const data = await res.json();
        
        if (res.ok && data.game) {
          currentGame = data.game;
          setStatus('status3', 'success');
          log(`âœ… Jogo criado/joined: ${data.game}`, 'success');
          document.getElementById('gameInfo').textContent = `Game ID: ${data.game}`;
          document.getElementById('btnSSE').disabled = false;
        } else {
          throw new Error(data.error || 'Join failed');
        }
      } catch (error) {
        setStatus('status3', 'error');
        log(`âŒ Erro ao entrar: ${error.message}`, 'error');
      }
    }

    function testSSE() {
      if (!currentGame || !currentNick) {
        log('âŒ Entra num jogo primeiro!', 'error');
        return;
      }
      
      setStatus('status4', 'pending');
      log('ðŸ“¡ Conectando ao stream SSE...', 'info');
      
      const url = `${SERVER}/update?game=${currentGame}&nick=${currentNick}`;
      eventSource = new EventSource(url);
      
      eventSource.onopen = () => {
        setStatus('status4', 'success');
        log('âœ… Stream SSE conectado!', 'success');
      };
      
      eventSource.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          log(`ðŸ“¦ Update recebido: ${JSON.stringify(data).substring(0, 100)}...`, 'info');
        } catch (e) {
          log(`ðŸ“¦ Mensagem SSE: ${event.data}`, 'info');
        }
      };
      
      eventSource.onerror = (error) => {
        setStatus('status4', 'error');
        log('âŒ Erro no stream SSE', 'error');
        eventSource.close();
      };
    }

    // Auto-teste ao carregar
    window.onload = () => {
      setTimeout(() => testConnection(), 500);
    };
  </script>
</body>
</html>